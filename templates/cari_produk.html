<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sistem Cek Produk</title>

<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon_new1.ico') }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
html, body {  
    height: 100%;
    margin: 0;
    display: flex;
    flex-direction: column;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(160deg, #3a3a3a 0%, #7f6856 50%, #2c2c2c 100%);
    color: #f1f1f1;
}

main { flex: 1 0 auto; }

header {
    background-color: #8B0000;
    color: white;
    padding: 10px 0;
    border-radius: 0 0 30px 30px;
    box-shadow: 0 40px 40px rgba(0,0,0,0.1);
    text-align: center;
}

/* Card form jarak dari header */
.card.p-4.mb-4 {
    margin-top: 10px;  /* jarak dari header */
    margin-bottom: 10px; /* jarak ke elemen berikutnya */
}

/* Hapus gap input & scan, pakai !important */
#cari-form .input-group {
    display: flex !important;
    gap: 0 !important;
}

/* Input */
#cari-form .input-group input.form-control {
    border-radius: 10px !important;
    padding: 0 10px !important;
    height: 42px !important;
    flex: 1 1 auto !important;
    margin-bottom: 0 !important; /* override margin default */
}

/* Tombol scan */
#cari-form #scan-btn {
    width: 48px !important;
    height: 42px !important;
    border: 2px solid #8B0000 !important;
    border-radius: 6px !important;
    background: none !important;
    color: #8B0000 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: .2s !important;
}
#cari-form #scan-btn:hover {
    background: #f8e6e6 !important;
    transform: scale(1.05) !important;
}

/* Hapus margin bawah mb-3 supaya tombol submit dekat input */
#cari-form > .mb-3 {
    margin-bottom: 4px !important; /* bisa 0 jika mau rapat sempurna */
}

#cari-form #submit-btn {
    width: 100% !important;
    padding: 8px !important;
    margin-top: 10px !important; /* rapat ke input */
    font-size: 1rem !important;
    font-weight: 600 !important;

    background-color: #a83232 !important; /* merah gelap */
    color: #fff !important;               /* teks putih */
    border: 2px solid #8B0000 !important; /* border tegas */
}
#cari-form #submit-btn:hover {
    background-color: #8B0000 !important;
}

/* Card hasil pencarian beri jarak dari tombol submit */
.card + .card {
    margin-top:10px;  /* jarak card hasil dari card form/button */
}
.card.result-card {
    margin-top: 2px !important;
}
.card.result-card h5 {
    margin-bottom: 5px; /* jarak judul ke garis */
}

.card.result-card hr {
    margin: 5px 0;  /* rapatkan garis ke judul dan ke tabel */
}

table.search-result {
    width:100%;
    border-collapse:collapse;
    color:#000;
    font-family:'Courier New', monospace;
    font-weight:bold;
    font-size:14px;
}
table.search-result th, table.search-result td {
    border:1px solid #ccc;
    padding:6px 10px;
}
table.search-result thead th {
    background:#8B0000;
    color:#fff;
    text-align:center;
}
table.search-result tbody td {
    text-align:center;
    vertical-align:middle;
}
table.search-result tbody td.nama-produk {
    text-align:left !important;
    white-space:normal;
}

main {
    flex: 1 0 auto; 
    margin-top: 20px; /* beri jarak dari header */
    padding-bottom: 10px; /* opsional, supaya konten tidak menempel footer */
}

footer {
    flex-shrink: 0; /* jangan mengecil */
    background-color: rgba(255, 255, 255, 0.2);
    border-top: 2px solid #6b0000;
    padding: 10px 0;
    font-size: 0.9em;
    color: #fff;
    border-radius: 30px 30px 0 0;
    text-align: center;
}

.btn-back {
    display: inline-block;
    margin: 10px auto;   
    background: rgba(0,0,0,0.5);
    color: #ffcc33;
    font-weight: 600;
    font-size: 0.85rem;
    padding: 6px 12px;
    border-radius: 8px;
    text-decoration: none;
    text-align: center;
    transition: all 0.2s ease;
}
.btn-back:hover {
    background: rgba(0,0,0,0.7);
    color: #fff;
}
@media (max-width: 768px) {
    /* Label lebih kecil */
    #cari-form .form-label {
        font-size: 0.78rem !important; /* default 1rem → lebih kecil */
    }

    /* Placeholder lebih kecil */
    #cari-form .form-control::placeholder {
        font-size: 0.78rem !important;
    }

    /* Input tetap nyaman, bisa sedikit lebih kecil */
    #cari-form .form-control {
        height: 36px !important; /* default 42px → lebih kecil */
        padding: 0 8px !important;
    }

    #cari-form #scan-btn {
        width: 38px !important;
        height: 36px !important;
        font-size: 0.9rem !important;
    }
}
#error-msg {
    display: block;
    margin-top: 4px;
    font-size: 0.85rem;
    color: #a83232;  /* merah konsisten dengan tombol */
}

/* QR reader */
#qr-reader { margin-top:10px; display:none; }

@media (max-width:768px) {
    #scan-btn { width:38px; height:38px; }
    table.search-result { font-size:12px; }
}
</style>
</head>

<body>
<header>
  <h2 data-aos="fade-down" data-aos-duration="800"><i class="bi bi-box-seam"></i> Sistem Cari Produk</h2>
</header>

<main class="container header-gap">
  <div class="row justify-content-center">
    <div class="col-md-10" data-aos="fade-up" data-aos-duration="1000">

      <!-- FORM -->
      <div class="card p-4 mb-4">
        <h5 class="text-center mb-3" style="color:#8B0000;">
          <i class="bi bi-search"></i> Cari Produk
        </h5>

        <form id="cari-form" action="{{ url_for('cari.cari_post') }}" method="post">
          
          <div class="mb-3">
  <label class="form-label fw-bold">Masukkan Prodcode / Barcode / Nama Produk</label>
  <div class="input-group">
    <input type="text" name="query" id="keyword"
           class="form-control"
           placeholder="Masukkan Prodcode/Barcode/Nama"
           value="{{ query }}">
    <button type="button" id="scan-btn" class="btn btn-outline-danger">
      <i class="bi bi-upc-scan"></i>
    </button>
  </div>

  <!-- Error inline dari Flask -->
  <div id="error-msg" class="text-danger small mt-1">
    {% if product_error %}
      {{ product_error }}
    {% endif %}
  </div>
</div>

          <!-- QR reader -->
          <div id="qr-reader" style="margin-top:10px; display:none;"></div>

          <button type="submit" id="submit-btn" class="btn btn-danger w-100 mt-3">
            <i class="bi bi-search"></i> Cari Produk
          </button>

        </form>
      </div>

    </div>
  </div>

     <!-- HASIL -->
{% if products %}
<div class="row justify-content-center">
  <div class="col-md-10">
    <div class="card p-4 result-card" style="margin-top:4px;"> <!-- jarak minimal -->
      <h5 style="color:#a83232;">
        <i class="bi bi-box"></i> Hasil Pencarian
      </h5>
      <hr>

      <div class="table-responsive">
        <table class="table search-result">
          <thead>
            <tr>
              <th>Cat-1</th>
              <th>Prodcode</th>
              <th>Barcode</th>
              <th style="min-width:250px;">Nama Produk</th>
              <th>Harga</th>
              <th>Stok</th>
              <th>Status</th>
              <th>UOM</th>
              <th>Vendor</th>
            </tr>
          </thead>
          <tbody>
            {% for p in products %}
            <tr>
              <td>{{ p.category }}</td>
              <td>{{ p.prodcode }}</td>
              <td>
                {% if p.barcode %}
                  {{ "%013d"|format(p.barcode|int) }}
                {% else %}
                  0
                {% endif %}
              </td>
              <td class="nama-produk">{{ p.nama_produk }}</td>
              <td>0</td>
              <td>0</td>
              <td>0</td>
              <td>0</td>
              <td>0</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

 </div>
  </div>
  {% endif %}
</main>

<div class="text-center mb-2">
  <a href="/" class="btn-back">
    <i class="bi bi-arrow-left-circle"></i> Kembali ke Menu
  </a>
</div>

<footer class="text-center mt-auto" style="
    background-color: rgba(255, 255, 255, 0.2);
    border-top:2px solid #6b0000;
    padding:10px 0;
    font-size:0.9em;
    color:#fff;
    border-radius:30px 30px 0 0;">
  <div>&copy; 2025 Eeng Irawan. All Rights Reserved.</div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
AOS.init();

/* ========================================================
   VALIDASI FORM — keyword (prodcode / barcode / nama)
   Tampil error inline, bukan popup
======================================================== */
const form = document.getElementById('cari-form');
const inputField = document.getElementById('keyword');

// Tambahkan div error di bawah input jika belum ada
let errorDiv = document.getElementById('error-msg');
if (!errorDiv) {
    errorDiv = document.createElement('div');
    errorDiv.id = 'error-msg';
    errorDiv.className = 'text-danger small mt-1';
    errorDiv.style.display = 'none';
    inputField.parentNode.appendChild(errorDiv);
}

form.addEventListener('submit', function(e){
    const input = inputField.value.trim();
    errorDiv.style.display = 'none'; // reset error

    if (!input) {
        e.preventDefault();
        errorDiv.textContent = "❌ Masukkan Prodcode, Barcode, atau Nama Produk.";
        errorDiv.style.display = 'block';
        return;
    }

    // --- Jika angka semua (prodcode/barcode) ---
    if (/^\d+$/.test(input)) {
        if (input.length === 10 || input.length === 13) return; // valid
        e.preventDefault();
        errorDiv.textContent = "❌ Prodcode harus 10 digit atau Barcode 13 digit.";
        errorDiv.style.display = 'block';
        return;
    }

    // --- Jika huruf / alfanumerik (nama produk) ---
    if (!/^[A-Za-z0-9 ]+$/.test(input)) {
        e.preventDefault();
        errorDiv.textContent = "❌ Nama produk hanya boleh huruf, angka, dan spasi.";
        errorDiv.style.display = 'block';
        return;
    }
});

// ================================================
// QR Scanner
// ================================================
let activeScanner = null;
let activeDiv = null;

function startScanner(targetButton, inputField, autoSubmit = false, readerId) {
  // Jika scanner sudah aktif → hentikan dulu
  if (activeScanner) {
    activeScanner.stop().catch(()=>{}).finally(()=>{
      if (activeDiv) activeDiv.remove();
      activeScanner = null;
      activeDiv = null;
    });
  }

  // Buat div baru untuk scan area
  const parentGroup = targetButton.closest('.input-group');
  const div = document.createElement("div");
  div.id = readerId;
  div.style.marginTop = "10px";
  div.style.textAlign = "center";
  div.style.border = "1px solid #ccc";
  div.style.borderRadius = "8px";
  div.style.padding = "5px";
  div.style.background = "#f9f9f9";

  parentGroup.insertAdjacentElement('afterend', div);

  activeScanner = new Html5Qrcode(readerId);
  activeDiv = div;

  setTimeout(() => {
    activeScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },

      // ketika berhasil scan
      decodedText => {
        inputField.value = decodedText;

        // stop scanner
        activeScanner.stop().then(()=>{
          div.remove();
          activeScanner = null;
          activeDiv = null;

          if (autoSubmit) {
            const form = inputField.closest("form");
            if (form) form.submit();
          }
        });
      },

      // error scan (abaikan)
      error => {}
    ).catch(err => {
      alert("Tidak dapat mengakses kamera.");
      div.remove();
      activeScanner = null;
      activeDiv = null;
    });

  }, 300);
}

// Klik di luar area → scanner tertutup otomatis
document.addEventListener('click', (e) => {
  if (activeScanner && activeDiv && !activeDiv.contains(e.target) && !e.target.closest('.input-group')) {
    activeScanner.stop().catch(()=>{}).finally(()=>{
      activeDiv.remove();
      activeScanner = null;
      activeDiv = null;
    });
  }
});

// Tombol scan untuk input barcode utama
const barcodeInput = document.getElementById("keyword");   // ← benar
const scanBtn = document.getElementById("scan-btn");

scanBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  startScanner(scanBtn, barcodeInput, true, "reader-barcode");
});

</script>
</body>
</html>
