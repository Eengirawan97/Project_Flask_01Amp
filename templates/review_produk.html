<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Review Produk Baru</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(160deg, #3a3a3a 0%, #7f6856 50%, #2c2c2c 100%);
    color: #fff;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    padding-top: 70px;
}   

header {
    background: #8B0000;
    color: #fff;
    text-align: center;
    padding: 10px 0;
    border-radius: 0 0 40px 40px;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
}

.container-card {
    background: rgba(255,255,255,0.1);
    border-radius: 18px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    padding: 25px 20px;
    margin: 20px auto 10px;
    max-height: 75vh;
    overflow-y: auto;
    color: #fff;
}

/* Table custom */
.table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto;
    text-align: center; /* default semua isi center */
}

.table th, .table td {
    color: #fff;
    font-weight: 600;
    border: 1px solid rgba(255,255,255,0.2);
    background-color: rgba(0,0,0,0.5);
    padding: 8px 12px;
    vertical-align: middle;
}

/* Semua header center */
.table th { 
    background-color: rgba(139,0,0,0.7);
    text-transform: uppercase;
    text-align: center;
}

/* Nama Produk tetap kiri */
.table th.nama-produk { text-align: center; }
.table td.nama-produk { text-align: left; min-width: 300px; max-width: 500px; white-space: normal; }

/* Kolom Prod Code & Aksi auto-width */
.table th:nth-child(3), .table td:nth-child(3),
.table th:nth-child(6), .table td:nth-child(6) {
    width: 1%;
    white-space: nowrap;
}

/* Baris ganjil lebih gelap */
.table tr:nth-of-type(odd) td { background-color: rgba(0,0,0,0.4); }

/* Tombol */
.btn-accept { background-color: #28a745; color: #fff; }
.btn-accept:hover { background-color: #218838; }
.btn-back { background-color: #8B0000; color: #fff; }
.btn-back:hover { background-color: #8B0000; }
.btn-danger { background-color: #dc3545; color: #fff; }
.btn-danger:hover { background-color: #c82333; }

/* Flash messages */
.flash-message { display: inline-block; padding: 6px 12px; border-radius: 6px; margin-bottom: 10px; font-weight: 500; }
.flash-success { background-color: #28a745a1; color: #fff; }
.flash-warning { background-color: #ffcc70a1; color: #000; }
.flash-danger { background-color: #dc3545a1; color: #fff; }

/* Animasi fade & slide */
.fade-slide {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.5s ease;
}

.fade-slide.visible {
    opacity: 1;
    transform: translateY(0);
}

.fade-slide.removing {
    opacity: 0;
    transform: translateX(-50px);
    height: 0;
    padding: 0;
    margin: 0;
    border: 0;
}

/* Tombol Accept/Reject dalam satu sel */
td form { display:inline-block; margin:0; }
td form + form { margin-left:5px; }
td button { min-width: 70px; }
</style>
</head>
<body>

<header>
    <h2>Review Produk Baru</h2>
</header>

<div class="container">
    <div class="container-card">

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, msg in messages %}
                <div class="flash-message flash-{{ category }}">{{ msg }}</div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        {% if all_product %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Category</th>
                        <th>Prod Code</th>
                        <th>Barcode</th>
                        <th class="nama-produk">Nama Produk</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in all_product %}
                    <tr class="fade-slide">
                        <td>{{ loop.index }}</td> 
                        <td>{{ p['category'] }}</td>
                        <td>{{ p['prodcode'] }}</td>
                        <td>{{ p['barcode'] }}</td>
                        <td class="nama-produk">{{ p['nama_produk'] }}</td>
                        <td class="text-center">
                            <form method="POST">
                                <input type="hidden" name="row_id" value="{{ loop.index0 }}">
                                <button type="button" name="action" value="accept" class="btn btn-accept btn-sm btn-remove">
                                    Accept <i class="bi bi-check-circle"></i>
                                </button>
                            </form>
                            <form method="POST">
                                <input type="hidden" name="row_id" value="{{ loop.index0 }}">
                                <button type="button" name="action" value="reject" class="btn btn-danger btn-sm btn-remove">
                                    Reject <i class="bi bi-x-circle"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
           <tr class="empty-row">
            <td colspan="6" class="text-center">Tidak ada produk baru untuk direview</td>
        </tr>
        {% endif %}
    
     <!-- Modal Reject -->
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header">
            <h5 class="modal-title" id="rejectModalLabel">Keterangan</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <textarea id="rejectNote" class="form-control" maxlength="50" placeholder="Masukkan keterangan..." rows="3"></textarea>
            <small class="text-muted">Maksimal 50 karakter</small>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="confirmReject" class="btn btn-danger">Lanjut</button>
          </div>
        </div>
      </div>
    </div>
    </div>

    <div class="text-center mt-3 mb-4">
        <a href="{{ url_for('manage_produk') }}" class="btn btn-back">
            <i class="bi bi-arrow-left-circle"></i> Kembali ke Menu
        </a>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const rows = document.querySelectorAll("tbody tr.fade-slide");
    rows.forEach((row, index) => {
        setTimeout(() => {
            row.classList.add("visible");
        }, index * 100);
    });

    let currentForm = null;
    const rejectModal = new bootstrap.Modal(document.getElementById('rejectModal'));
    const confirmRejectBtn = document.getElementById("confirmReject");

    const removeButtons = document.querySelectorAll(".btn-remove");
    removeButtons.forEach(btn => {
        btn.addEventListener("click", function(e) {
            e.preventDefault();
            const form = btn.closest("form");

            if(btn.value === "accept") {
                // Accept → fade-slide dan submit
                const row = btn.closest("tr");
                row.classList.add("removing");

                const tempInput = document.createElement("input");
                tempInput.type = "hidden";
                tempInput.name = btn.name;
                tempInput.value = btn.value;
                form.appendChild(tempInput);

                setTimeout(() => {
                    form.submit();
                }, 500);
            } else if(btn.value === "reject") {
                // Reject → buka modal
                currentForm = form;
                rejectModal.show();
            }
        });
    });

    // Modal Lanjut (Reject)
    confirmRejectBtn.addEventListener("click", function() {
        if(currentForm) {
            const note = document.getElementById("rejectNote").value.trim();

            const noteInput = document.createElement("input");
            noteInput.type = "hidden";
            noteInput.name = "keterangan";
            noteInput.value = note;
            currentForm.appendChild(noteInput);

            const actionInput = document.createElement("input");
            actionInput.type = "hidden";
            actionInput.name = "action";
            actionInput.value = "reject";
            currentForm.appendChild(actionInput);

            currentForm.submit();
        }
    });

    // Reset textarea saat modal ditutup
    document.getElementById('rejectModal').addEventListener('hidden.bs.modal', function () {
        document.getElementById('rejectNote').value = '';
    });
});
</script>
</body>
</html>
